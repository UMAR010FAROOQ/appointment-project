{% extends 'user/base.html' %}
{% load static %}
{% block title %}
  | My Appointments
{% endblock %}
{% block contentBody %}
  <div class="breadcrumb-bar-two">
    <div class="container">
      <div class="row align-items-center inner-banner">
        <div class="col-md-12 col-12 text-center">
          <h2 class="breadcrumb-title">My Appointments</h2>
          <nav aria-label="breadcrumb" class="page-breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a href="{% url 'core:HomePage' %}">Home</a>
              </li>
              <li class="breadcrumb-item" aria-current="page">My Appointments</li>
            </ol>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <div class="content doctor-content">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 col-xl-3 theiaStickySidebar">
          {% include 'user/user-dash-slider.html' %}
        </div>

        <div class="col-lg-8 col-xl-9">
          <div class="dashboard-header">
            <h3>Appointments</h3>
            <ul class="header-list-btns">
              <li>
                <div class="input-block dash-search-input">
                  <input type="text" id="search-input" class="form-control" placeholder="Search" />
                  <span class="search-icon"><i class="fa-solid fa-magnifying-glass"></i></span>
                </div>
              </li>
            </ul>
          </div>

          <div class="appointment-tab-head">
            <div class="appointment-tabs">
              <ul class="nav nav-pills inner-tab" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="pills-upcoming-tab" data-bs-toggle="pill" data-bs-target="#pills-upcoming" type="button" role="tab" aria-controls="pills-upcoming" aria-selected="false">Upcoming<span>{{ upcoming_appointments.paginator.count }}</span></button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="pills-complete-tab" data-bs-toggle="pill" data-bs-target="#pills-complete" type="button" role="tab" aria-controls="pills-complete" aria-selected="true">Completed<span>{{ completed_appointments.paginator.count }}</span></button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="pills-cancelled-tab" data-bs-toggle="pill" data-bs-target="#pills-cancelled" type="button" role="tab" aria-controls="pills-cancelled" aria-selected="true">Cancelled<span>{{ cancelled_appointments.paginator.count }}</span></button>
                </li>
              </ul>
            </div>
          </div>

          <div class="tab-content appointment-tab-content">
            <!-- Upcoming Appointments -->
            <div class="tab-pane fade {% if active_tab == 'pills-upcoming' %}show active{% endif %}" id="pills-upcoming" role="tabpanel" aria-labelledby="pills-upcoming-tab">
              {% for appointment in upcoming_appointments %}
                <div class="appointment-wrap">
                  <ul>
                    <li>
                      <div class="patinet-information">
                        <img src="{{ appointment.instructor.user.profile_image.url|default:'/static/img/doctor-profiles/default-user.png' }}" alt="Image" />
                        <div class="patient-info">
                          <p>#{{ appointment.id }}</p>
                          <h6>{{ appointment.instructor.user.first_name }}</h6>
                        </div>
                      </div>
                    </li>
                    <li class="appointment-info">
                      <p>
                        <i class="fa-solid fa-calendar"></i>{{ appointment.appointment_date }}
                      </p>
                      <p>
                        <i class="fa-solid fa-clock"></i>{{ appointment.time_slot.day_of_week }}: {{ appointment.time_slot.start_time }} - {{ appointment.time_slot.end_time }}
                      </p>
                    </li>
                    <li class="mail-info-patient">
                      <p>
                        <i class="fa-solid fa-envelope me-2"></i>{{ appointment.email }}
                      </p>
                    </li>
                    <li class="appointment-detail-btn">
                      <span class="badge badge-warning-bg">Upcoming</span>
                    </li>
                  </ul>
                </div>
              {% empty %}
                <p>No upcoming appointments.</p>
              {% endfor %}
              <div class="pagination dashboard-pagination gap-2">
                {% if upcoming_appointments.paginator.num_pages > 1 %}
                  {% for page_num in upcoming_appointments.paginator.page_range %}
                    <a href="?upcoming_page={{ page_num }}" class="page-link rounded {% if upcoming_appointments.number == page_num %}active{% endif %}">{{ page_num }}</a>
                  {% endfor %}
                {% endif %}
              </div>
            </div>

            <!-- Completed Appointments -->
            <div class="tab-pane fade {% if active_tab == 'pills-complete' %}show active{% endif %}" id="pills-complete" role="tabpanel" aria-labelledby="pills-complete-tab">
              {% for appointment in completed_appointments %}
                <div class="appointment-wrap">
                  <ul>
                    <li>
                      <div class="patinet-information">
                        <img src="{{ appointment.instructor.user.profile_image.url|default:'/static/img/doctor-profiles/default-user.png' }}" alt="Doctor Image" />
                        <div class="patient-info">
                          <p>#{{ appointment.id }}</p>
                          <h6>{{ appointment.instructor.user.first_name }}</h6>
                        </div>
                      </div>
                    </li>
                    <li class="appointment-info">
                      <p>
                        <i class="fa-solid fa-calendar"></i>{{ appointment.appointment_date }}
                      </p>
                      <p>
                        <i class="fa-solid fa-clock"></i>{{ appointment.time_slot.day_of_week }}: {{ appointment.time_slot.start_time }} - {{ appointment.time_slot.end_time }}
                      </p>
                    </li>
                    <li class="mail-info-patient">
                      <p>
                        <i class="fa-solid fa-envelope me-2"></i>{{ appointment.email }}
                      </p>
                    </li>
                    <li class="appointment-detail-btn">
                      <span class="badge badge-success-bg">Completed</span>
                    </li>
                  </ul>
                </div>
              {% empty %}
                <p>No completed appointments.</p>
              {% endfor %}
              <div class="pagination dashboard-pagination gap-2">
                {% if completed_appointments.paginator.num_pages > 1 %}
                  {% for page_num in completed_appointments.paginator.page_range %}
                    <a href="?completed_page={{ page_num }}" class="page-link rounded {% if completed_appointments.number == page_num %}active{% endif %}">{{ page_num }}</a>
                  {% endfor %}
                {% endif %}
              </div>
            </div>

            <!-- Cancelled Appointments -->
            <div class="tab-pane fade {% if active_tab == 'pills-cancelled' %}show active{% endif %}" id="pills-cancelled" role="tabpanel" aria-labelledby="pills-cancelled-tab">
              {% for appointment in cancelled_appointments %}
                <div class="appointment-wrap">
                  <ul>
                    <li>
                      <div class="patinet-information">
                        <img src="{{ appointment.instructor.user.profile_image.url|default:'/static/img/doctor-profiles/default-user.png' }}" alt="Doctor Image" />
                        <div class="patient-info">
                          <p>#{{ appointment.id }}</p>
                          <h6>{{ appointment.instructor.user.first_name }}</h6>
                        </div>
                      </div>
                    </li>
                    <li class="appointment-info">
                      <p>
                        <i class="fa-solid fa-calendar"></i>{{ appointment.appointment_date }}
                      </p>
                      <p>
                        <i class="fa-solid fa-clock"></i>{{ appointment.time_slot.day_of_week }}: {{ appointment.time_slot.start_time }} - {{ appointment.time_slot.end_time }}
                      </p>
                    </li>
                    <li class="mail-info-patient">
                      <p>
                        <i class="fa-solid fa-envelope me-2"></i>{{ appointment.email }}
                      </p>
                    </li>
                    <li class="appointment-detail-btn">
                      <span class="badge badge-danger-bg">Cancelled</span>
                    </li>
                  </ul>
                </div>
              {% empty %}
                <p>No cancelled appointments.</p>
              {% endfor %}
              <div class="pagination dashboard-pagination gap-2">
                {% if cancelled_appointments.paginator.num_pages > 1 %}
                  {% for page_num in cancelled_appointments.paginator.page_range %}
                    <a href="?cancelled_page={{ page_num }}" class="page-link rounded {% if cancelled_appointments.number == page_num %}active{% endif %}">{{ page_num }}</a>
                  {% endfor %}
                {% endif %}
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const searchInput = document.getElementById('search-input');
      const tabs = document.querySelectorAll('.nav-link[data-bs-toggle="pill"]');
      const tabContent = document.querySelector('.tab-content');
  
      // Debounce function to limit the frequency of search
      const debounce = (func, delay) => {
        let timer;
        return function (...args) {
          clearTimeout(timer);
          timer = setTimeout(() => func.apply(this, args), delay);
        };
      };
  
      // Filter appointments
      const filterAppointments = (query) => {
        const activeTabPane = tabContent.querySelector('.tab-pane.show.active');
        const appointments = activeTabPane.querySelectorAll('.appointment-wrap');
        let hasResults = false;
  
        appointments.forEach((appointment) => {
          const appointmentText = appointment.textContent.toLowerCase();
          if (appointmentText.includes(query.toLowerCase())) {
            appointment.style.display = '';
            hasResults = true;
          } else {
            appointment.style.display = 'none';
          }
        });
  
        // Show "No appointments found" message if no results
        const noResultsMessage = activeTabPane.querySelector('.no-results');
        if (!hasResults) {
          if (!noResultsMessage) {
            const message = document.createElement('p');
            message.classList.add('no-results', 'text-center', 'mt-3');
            message.textContent = 'No appointments found.';
            activeTabPane.appendChild(message);
          }
        } else {
          if (noResultsMessage) {
            noResultsMessage.remove();
          }
        }
      };
  
      // Debounced search handler
      const handleSearch = debounce((event) => {
        const query = event.target.value.trim();
        filterAppointments(query);
      }, 300);
  
      // Attach search input event listener
      searchInput.addEventListener('input', handleSearch);
  
      // Reset search when switching tabs
      tabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          searchInput.value = '';
          filterAppointments(''); // Reset filtering
        });
      });
    });
  </script>
  

{% endblock %}
